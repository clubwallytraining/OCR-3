<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Camera Stream with Video.js</title>
    
    <!-- Video.js CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/video.js/9.1.0/video-js.min.css" rel="stylesheet">
    
    <!-- Custom Styles -->
    <style>
        /* Apply dark theme to the entire page */
        body {
            margin: 0;
            padding: 0;
            background-color: #121212;
            color: #ffffff;
            font-family: Arial, sans-serif;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        /* Video.js player styling to cover the entire viewport */
        .video-js {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Ensures the video covers the entire viewport */
        }

        /* Floating buttons container at the bottom center */
        .controls-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            overflow-x: auto;
            padding: 10px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 30px;
            z-index: 1000;
        }

        /* Hide scrollbar for WebKit browsers */
        .controls-container::-webkit-scrollbar {
            display: none;
        }

        /* Styling for control buttons */
        .control-button {
            flex: 0 0 auto;
            margin: 0 10px;
            padding: 15px 20px;
            background-color: #1f1f1f;
            border: none;
            border-radius: 50px;
            color: #ffffff;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s;
            display: flex;
            align-items: center;
        }

        /* Hover effect for buttons */
        .control-button:hover {
            background-color: #333333;
            transform: scale(1.05);
        }

        /* FPS Counter styling in the top-left corner */
        #fpsCounter {
            position: fixed;
            top: 10px;
            left: 10px;
            color: #ffffff;
            font-size: 18px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }

        /* Error message styling centered on the screen */
        #errorMessage {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 0, 0, 0.8);
            padding: 20px 30px;
            border-radius: 10px;
            color: #ffffff;
            font-size: 18px;
            display: none; /* Hidden by default */
            z-index: 1001;
        }

        /* Modal overlay styling */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 1002;
        }

        /* Modal content styling */
        .modal-content {
            background: #1f1f1f;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 400px;
        }

        /* Modal header */
        .modal-header {
            font-size: 20px;
            margin-bottom: 10px;
            text-align: center;
        }

        /* List styling inside modals */
        .modal-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .modal-list li {
            padding: 10px;
            background: #2c2c2c;
            margin-bottom: 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .modal-list li:hover {
            background: #444444;
        }

        /* Close button for modals */
        .close-button {
            display: block;
            margin: 10px auto 0;
            padding: 10px 20px;
            background-color: #333333;
            border: none;
            border-radius: 5px;
            color: #ffffff;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .close-button:hover {
            background-color: #555555;
        }
    </style>
</head>
<body>
    <!-- FPS Counter -->
    <div id="fpsCounter">FPS: 0</div>

    <!-- Video.js Player -->
    <video
        id="myVideo"
        class="video-js vjs-default-skin"
        playsinline
        autoplay
        muted
    ></video>

    <!-- Controls Carousel -->
    <div class="controls-container">
        <button id="cameraButton" class="control-button">Camera</button>
        <button id="resolutionButton" class="control-button">Resolution</button>
    </div>

    <!-- Error Message -->
    <div id="errorMessage"></div>

    <!-- Camera Selection Modal -->
    <div id="cameraModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">Select Camera</div>
            <ul id="cameraList" class="modal-list"></ul>
            <button class="close-button" onclick="closeModal('cameraModal')">Close</button>
        </div>
    </div>

    <!-- Resolution Selection Modal -->
    <div id="resolutionModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">Select Resolution</div>
            <ul id="resolutionList" class="modal-list"></ul>
            <button class="close-button" onclick="closeModal('resolutionModal')">Close</button>
        </div>
    </div>

    <!-- Video.js JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/video.js/9.1.0/video.min.js"></script>
    
    <!-- Custom Scripts -->
    <script>
        // Ensure the script runs after the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', async () => {
            const fpsCounter = document.getElementById('fpsCounter');
            const errorMessage = document.getElementById('errorMessage');
            let videoStream = null;
            let videoPlayer = null;
            let fps = 0;
            let lastFrameTime = performance.now();
            let frameCount = 0;

            // Predefined resolutions
            const resolutions = [
                { label: '720p', width: 1280, height: 720 },
                { label: '1080p', width: 1920, height: 1080 },
                { label: '4K', width: 3840, height: 2160 }
            ];
            let currentResolution = resolutions[0]; // Default to 720p

            // Available video input devices
            let videoInputDevices = [];
            let currentCameraId = null; // ID of the currently selected camera

            /**
             * Display error messages to the user
             * @param {string} message - The error message to display
             */
            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
            }

            /**
             * Initialize the Video.js player with the given stream
             * @param {MediaStream} stream - The media stream to display
             */
            function initializeVideoPlayer(stream) {
                if (videoPlayer) {
                    videoPlayer.dispose(); // Dispose existing player if any
                }

                // Initialize Video.js player with the MediaStream directly
                videoPlayer = videojs('myVideo', {
                    autoplay: true,
                    controls: false,
                    fluid: true,
                    preload: 'auto'
                });

                // Set the video source to the MediaStream
                const videoElement = document.getElementById('myVideo_html5_api');
                if ('srcObject' in videoElement) {
                    videoElement.srcObject = stream;
                } else {
                    // Fallback for older browsers
                    videoElement.src = URL.createObjectURL(stream);
                }

                videoPlayer.play();

                // Enable hardware acceleration via CSS
                if (videoElement) {
                    videoElement.style.transform = 'translateZ(0)';
                }

                // Start FPS monitoring
                requestAnimationFrame(updateFPS);
            }

            /**
             * Update the FPS counter
             */
            function updateFPS() {
                const now = performance.now();
                frameCount++;
                const delta = now - lastFrameTime;
                if (delta >= 1000) { // Update every second
                    fps = frameCount;
                    frameCount = 0;
                    lastFrameTime = now;
                    fpsCounter.textContent = `FPS: ${fps}`;
                }
                requestAnimationFrame(updateFPS);
            }

            /**
             * Get list of available video input devices
             */
            async function getVideoInputDevices() {
                try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    videoInputDevices = devices.filter(device => device.kind === 'videoinput');
                } catch (err) {
                    showError('Error accessing media devices.');
                    console.error(err);
                }
            }

            /**
             * Start the video stream with given constraints
             * @param {string} deviceId - The device ID of the camera to use
             * @param {object} resolution - The resolution constraints
             */
            async function startVideoStream(deviceId, resolution) {
                // Stop any existing streams
                if (videoStream) {
                    videoStream.getTracks().forEach(track => track.stop());
                }

                // Define media constraints
                const constraints = {
                    video: {
                        deviceId: deviceId ? { exact: deviceId } : undefined,
                        width: { exact: resolution.width },
                        height: { exact: resolution.height }
                    },
                    audio: false
                };

                try {
                    // Request media stream with constraints
                    videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                    initializeVideoPlayer(videoStream);
                } catch (err) {
                    // Handle specific errors
                    if (err.name === 'NotAllowedError') {
                        showError('Camera access denied. Please allow camera permissions to use this feature.');
                    } else if (err.name === 'NotFoundError') {
                        showError('No camera devices found with the selected settings.');
                    } else {
                        showError('Error accessing the camera.');
                    }
                    console.error(err);
                }
            }

            /**
             * Initialize the camera by requesting permissions and starting the stream
             */
            async function initializeCamera() {
                try {
                    // Directly request camera access, which will prompt if not already granted
                    videoStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                    await getVideoInputDevices();
                    if (videoInputDevices.length === 0) {
                        showError('No camera devices found.');
                        return;
                    }
                    // Start video stream with the first available camera and default resolution
                    currentCameraId = videoInputDevices[0].deviceId;
                    await startVideoStream(currentCameraId, currentResolution);
                } catch (err) {
                    // Handle specific errors
                    if (err.name === 'NotAllowedError') {
                        showError('Camera access denied. Please allow camera permissions to use this feature.');
                    } else if (err.name === 'NotFoundError') {
                        showError('No camera devices found.');
                    } else {
                        showError('Unable to access the camera.');
                    }
                    console.error(err);
                }
            }

            /**
             * Setup the Camera selection button to open the camera selection modal
             */
            function setupCameraButton() {
                const cameraButton = document.getElementById('cameraButton');
                cameraButton.addEventListener('click', () => {
                    populateCameraList();
                    openModal('cameraModal');
                });
            }

            /**
             * Setup the Resolution selection button to open the resolution selection modal
             */
            function setupResolutionButton() {
                const resolutionButton = document.getElementById('resolutionButton');
                resolutionButton.addEventListener('click', () => {
                    populateResolutionList();
                    openModal('resolutionModal');
                });
            }

            /**
             * Populate the Camera selection list in the modal
             */
            function populateCameraList() {
                const cameraList = document.getElementById('cameraList');
                cameraList.innerHTML = ''; // Clear existing list

                videoInputDevices.forEach((device, index) => {
                    const li = document.createElement('li');
                    li.textContent = device.label || `Camera ${index + 1}`;
                    li.addEventListener('click', async () => {
                        currentCameraId = device.deviceId;
                        await startVideoStream(currentCameraId, currentResolution);
                        closeModal('cameraModal');
                    });
                    cameraList.appendChild(li);
                });
            }

            /**
             * Populate the Resolution selection list in the modal
             */
            function populateResolutionList() {
                const resolutionList = document.getElementById('resolutionList');
                resolutionList.innerHTML = ''; // Clear existing list

                resolutions.forEach((res) => {
                    const li = document.createElement('li');
                    li.textContent = res.label;
                    li.addEventListener('click', async () => {
                        currentResolution = res;
                        await startVideoStream(currentCameraId, currentResolution);
                        closeModal('resolutionModal');
                    });
                    resolutionList.appendChild(li);
                });
            }

            /**
             * Open a modal by its ID
             * @param {string} modalId - The ID of the modal to open
             */
            function openModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'flex';
                }
            }

            /**
             * Close a modal by its ID
             * @param {string} modalId - The ID of the modal to close
             */
            function closeModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'none';
                }
            }

            /**
             * Close modals when clicking outside the modal content
             */
            window.addEventListener('click', (event) => {
                const cameraModal = document.getElementById('cameraModal');
                const resolutionModal = document.getElementById('resolutionModal');
                if (event.target === cameraModal) {
                    closeModal('cameraModal');
                }
                if (event.target === resolutionModal) {
                    closeModal('resolutionModal');
                }
            });

            // Initialize the application
            await initializeCamera();
            setupCameraButton();
            setupResolutionButton();
        });
    </script>
</body>
</html>
