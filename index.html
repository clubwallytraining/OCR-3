<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Mobile Camera Stream with Video.js</title>
    <!-- Dark Theme Background -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Video.js CDN (Latest Version) -->
    <link rel="stylesheet" href="https://vjs.zencdn.net/8.0.4/video-js.css" />
    <script src="https://vjs.zencdn.net/8.0.4/video.min.js"></script>

    <style>
        /* Global Dark Theme */
        html, body {
            margin: 0;
            padding: 0;
            background-color: #121212;
            color: #FFFFFF;
            font-family: sans-serif;
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        /* Container for the video */
        #videoContainer {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        /* The Video.js player styling */
        .video-js {
            width: 100% !important;
            height: 100% !important;
            background-color: #000000;
        }

        /* Floating camera settings panel */
        #cameraSettingsPanel {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: row;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 20px;
            padding: 8px;
            z-index: 9999;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
        }

        /* Horizontal carousel for camera/resolution buttons */
        #cameraSettingsPanel .carouselContainer {
            display: flex;
            flex-direction: row;
            gap: 8px;
            overflow-x: auto;
            scrollbar-width: none; /* Hide scrollbar in Firefox */
        }
        #cameraSettingsPanel .carouselContainer::-webkit-scrollbar {
            display: none; /* Hide scrollbar in Chrome, Safari, Opera */
        }

        /* Button styling */
        .settingBtn {
            flex: 0 0 auto;
            background-color: #1f1f1f;
            color: #ffffff;
            border: none;
            border-radius: 16px;
            padding: 10px 16px;
            cursor: pointer;
            white-space: nowrap;
            transition: background-color 0.3s ease;
            font-size: 14px;
        }
        .settingBtn:hover {
            background-color: #333333;
        }

        /* FPS counter in the top left corner */
        #fpsCounter {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #FFFFFF;
            font-size: 16px;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.7);
            z-index: 9999;
            pointer-events: none; /* Let clicks pass through to the video */
        }
    </style>
</head>
<body>
    <div id="videoContainer">
        <!-- FPS Counter -->
        <div id="fpsCounter">FPS: 0</div>

        <!-- Video.js Player -->
        <video
            id="myVideo"
            class="video-js vjs-default-skin"
            playsinline
            autoplay
            muted
        ></video>

        <!-- Floating Camera/Resolution Button Panel -->
        <div id="cameraSettingsPanel">
            <div class="carouselContainer" id="carouselContainer">
                <!-- Buttons for camera selection and resolutions will be dynamically added here -->
            </div>
        </div>
    </div>

    <script>
        /*
         *  This script does the following:
         *  1. Checks/requests camera permissions.
         *  2. After permission is granted the first time, refreshes the page so that we can initialize the stream.
         *  3. Enumerates all available video input devices and populates them as selectable buttons.
         *  4. Enumerates a few common resolutions for each camera so user can pick the desired size.
         *  5. Uses Video.js to display the chosen camera stream with hardware acceleration where available.
         *  6. Displays an FPS counter in the top-left corner.
         */

        // Track camera permission in session to know if we've prompted
        const cameraPermissionKey = 'cameraPermissionsChecked';

        // Some preset resolutions for user selection
        const possibleResolutions = [
            { width: 640, height: 480, label: '480p' },
            { width: 1280, height: 720, label: '720p' },
            { width: 1920, height: 1080, label: '1080p' }
        ];

        // If we have not yet checked for permissions, attempt to do so now
        (async function checkCameraPermissions() {
            if (!sessionStorage.getItem(cameraPermissionKey)) {
                try {
                    // Attempt to get access to the camera
                    await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                    // If successful, store permission state and refresh the page
                    sessionStorage.setItem(cameraPermissionKey, 'granted');
                    window.location.reload();
                } catch (err) {
                    console.warn("User denied camera permissions or an error occurred:", err);
                    // If user denies or there's an error, we won't auto-refresh.
                    // The user can manually enable permissions in the browser settings or reload.
                }
            } else {
                // Permissions likely granted previously, proceed
                initPage();
            }
        })();

        let player = null;
        let currentStream = null;

        async function initPage() {
            // Initialize the Video.js player
            player = videojs('myVideo', {
                autoplay: true,
                controls: false,
                fluid: true,
                html5: {
                    // Attempt hardware acceleration if available
                    nativeVideoTracks: false,
                    nativeAudioTracks: false,
                    nativeTextTracks: false
                }
            });

            // Populate camera and resolution selections
            await populateCameraSettings();

            // Start with the first available camera at the default resolution
            // (We'll choose the first device ID and one of our preset resolutions)
            const devices = await navigator.mediaDevices.enumerateDevices();
            const firstCamera = devices.find(d => d.kind === 'videoinput');
            if (firstCamera) {
                await setCamera(firstCamera.deviceId, possibleResolutions[1]); // default to 720p
            }

            // Start the FPS counter
            startFPSCounter();
        }

        async function populateCameraSettings() {
            const deviceInfos = await navigator.mediaDevices.enumerateDevices();
            const videoDevices = deviceInfos.filter(device => device.kind === 'videoinput');

            const carouselContainer = document.getElementById('carouselContainer');
            carouselContainer.innerHTML = ''; // Clear existing buttons if any

            // For each camera
            videoDevices.forEach((cameraDevice) => {
                // For each resolution
                possibleResolutions.forEach(res => {
                    const button = document.createElement('button');
                    button.className = 'settingBtn';
                    button.textContent = `${cameraDevice.label || 'Camera'} (${res.label})`;
                    button.onclick = () => {
                        setCamera(cameraDevice.deviceId, res);
                    };
                    carouselContainer.appendChild(button);
                });
            });
        }

        async function setCamera(deviceId, resolutionObj) {
            // Stop any active stream before starting a new one
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }

            try {
                const constraints = {
                    video: {
                        deviceId: { exact: deviceId },
                        width: { exact: resolutionObj.width },
                        height: { exact: resolutionObj.height }
                    },
                    audio: false
                };

                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                currentStream = stream;
                // Set the player source to the new stream
                if (player) {
                    player.srcObject = stream;
                    player.play();
                }
            } catch (error) {
                console.error("Could not set camera:", error);
            }
        }

        // Simple FPS counter using requestAnimationFrame timing
        let lastTimestamp = 0;
        let frames = 0;
        function startFPSCounter() {
            function updateFPSCounter(timestamp) {
                if (!lastTimestamp) {
                    lastTimestamp = timestamp;
                }
                frames++;
                const delta = timestamp - lastTimestamp;
                if (delta >= 1000) {
                    const fps = (frames * 1000 / delta).toFixed(1);
                    document.getElementById('fpsCounter').innerText = `FPS: ${fps}`;
                    frames = 0;
                    lastTimestamp = timestamp;
                }
                requestAnimationFrame(updateFPSCounter);
            }
            requestAnimationFrame(updateFPSCounter);
        }
    </script>
</body>
</html>
