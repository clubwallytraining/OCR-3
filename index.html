<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Mobile Camera Stream - Video.js</title>

  <!-- Latest Video.js CSS via CDN -->
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/video.js/8.4.0/video-js.min.css"
    rel="stylesheet"
  />

  <style>
    /****************************************************
     * RESET & LAYOUT
     ****************************************************/
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background-color: #121212; /* dark background */
      color: #ffffff;
      font-family: sans-serif;
      overflow: hidden; /* prevent scrolling - entire viewport used by video */
    }

    #videoContainer {
      position: relative;
      width: 100vw;
      height: 100vh;
      background: #000; /* fallback if no video */
      display: flex;
      justify-content: center;
      align-items: center;
    }

    /****************************************************
     * VIDEO.JS PLAYER
     ****************************************************/
    .video-js {
      width: 100vw !important;
      height: 100vh !important;
      object-fit: cover;
      background-color: #000;
    }
    /* Hardware acceleration to boost performance on mobile */
    .vjs-tech {
      will-change: transform;
      transform: translateZ(0);
      backface-visibility: hidden;
    }

    /****************************************************
     * FPS COUNTER
     ****************************************************/
    #fpsCounter {
      position: absolute;
      top: 10px;
      left: 10px;
      font-size: 14px;
      font-weight: bold;
      color: #fff;
      text-shadow: 0 0 5px rgba(0,0,0,0.8);
      z-index: 9999;
    }

    /****************************************************
     * BUTTONS FOR CAMERA & RESOLUTION
     ****************************************************/
    /* Common style for floating buttons */
    .floatingBtn {
      position: absolute;
      right: 20px;
      border: none;
      border-radius: 25px;
      background-color: #444;
      color: #fff;
      padding: 12px 20px;
      cursor: pointer;
      font-size: 14px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.3);
      transition: background-color 0.3s;
      z-index: 9998;
    }
    .floatingBtn:hover {
      background-color: #666;
    }

    /* Camera button at bottom (stack them with small offset) */
    #cameraBtn {
      bottom: 80px;
    }

    /* Resolution button below camera button */
    #resolutionBtn {
      bottom: 20px;
    }

    /****************************************************
     * OVERLAY PANELS FOR CAMERA DEVICES & RESOLUTIONS
     ****************************************************/
    .overlayPanel {
      position: absolute;
      right: 20px;
      bottom: 140px; /* appear above the camera & resolution buttons */
      background-color: rgba(0,0,0,0.8);
      border-radius: 10px;
      padding: 10px;
      display: none; /* toggled dynamically */
      max-height: 50vh; /* scroll within panel if many items */
      overflow-y: auto;
      min-width: 120px;
      z-index: 9999;
    }

    /* Each option in the overlay panel */
    .optionBtn {
      display: block;
      width: 100%;
      margin: 5px 0;
      padding: 8px 12px;
      text-align: center;
      background-color: #333;
      border-radius: 20px;
      color: #fff;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s;
      text-overflow: ellipsis;
      white-space: nowrap;
      overflow: hidden;
    }
    .optionBtn:hover {
      background-color: #555;
    }
  </style>
</head>
<body>
  <!-- NOTE: If testing locally, serve over HTTPS or use a secure environment. -->

  <div id="videoContainer">
    <!-- FPS counter -->
    <div id="fpsCounter">FPS: --</div>

    <!-- Video.js Player -->
    <video 
      id="myVideo" 
      class="video-js vjs-default-skin"
      playsinline 
      autoplay 
      muted
    ></video>

    <!-- CAMERA & RESOLUTION BUTTONS -->
    <button id="cameraBtn" class="floatingBtn">Switch Camera</button>
    <button id="resolutionBtn" class="floatingBtn">Switch Resolution</button>

    <!-- CAMERA DEVICES OVERLAY -->
    <div id="cameraPanel" class="overlayPanel"></div>

    <!-- RESOLUTIONS OVERLAY -->
    <div id="resolutionPanel" class="overlayPanel"></div>
  </div>

  <!-- Video.js JS (latest version via CDN) -->
  <script 
    src="https://cdnjs.cloudflare.com/ajax/libs/video.js/8.4.0/video.min.js"
    integrity="sha512-/lgqE+NF1IemhKn2ld5oFascsMVlWH++6vxtMBlQcvPZlF7Nov4z3HxURmC8JIvh3i45s5rtr7xK4ryhpzbTvg=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer">
  </script>

  <script>
    /****************************************************
     * GLOBALS
     ****************************************************/
    let player;             // Video.js instance
    let currentStream;      // MediaStream currently playing
    let selectedDeviceId;   // Current camera device ID
    let selectedResolution = { width: 1280, height: 720 }; // Default
    let availableDevices = []; // { deviceId, label, kind }

    const cameraPanel = document.getElementById("cameraPanel");
    const resolutionPanel = document.getElementById("resolutionPanel");

    const availableResolutions = [
      { label: "480p", width: 640, height: 480 },
      { label: "720p", width: 1280, height: 720 },
      { label: "1080p", width: 1920, height: 1080 }
    ];

    /****************************************************
     * PERMISSIONS CHECK ON LOAD
     ****************************************************/
    (async function checkPermissionsAndInit() {
      console.log("[checkPermissionsAndInit] Checking for camera permission...");
      try {
        // Attempt to get a simple video stream
        await navigator.mediaDevices.getUserMedia({ video: true });
        console.log("[checkPermissionsAndInit] Permission already granted.");
        initPage();
      } catch (error) {
        console.warn("[checkPermissionsAndInit] Permission not granted:", error);
        try {
          console.log("[checkPermissionsAndInit] Requesting permission...");
          await navigator.mediaDevices.getUserMedia({ video: true });
          alert("Permissions granted. The page will now refresh to set up camera.");
          location.reload();
        } catch (e) {
          console.error("[checkPermissionsAndInit] Camera permission denied or error:", e);
          alert("Camera permission is required. Please allow it in your browser settings, then reload.");
        }
      }
    })();

    /****************************************************
     * INIT PAGE AFTER PERMISSION
     ****************************************************/
    async function initPage() {
      console.log("[initPage] Initializing page...");
      await enumerateVideoDevices();

      // Initialize the Video.js player
      player = videojs('myVideo', {
        autoplay: true,
        controls: false,
        muted: true,
        fluid: false
      });

      // Pick the first device by default
      if (availableDevices.length > 0) {
        selectedDeviceId = availableDevices[0].deviceId;
      }

      // Start the stream
      await startCameraStream();

      // Set up the FPS counter
      setupFPSCounter();

      // Build overlay for camera devices
      buildCameraOverlay();

      // Build overlay for resolutions
      buildResolutionOverlay();

      // Attach event listeners for toggling overlays
      document.getElementById("cameraBtn").addEventListener("click", () => {
        togglePanel(cameraPanel);
        hidePanel(resolutionPanel); // hide resolution panel if open
      });

      document.getElementById("resolutionBtn").addEventListener("click", () => {
        togglePanel(resolutionPanel);
        hidePanel(cameraPanel); // hide camera panel if open
      });
    }

    /****************************************************
     * ENUMERATE VIDEO DEVICES
     ****************************************************/
    async function enumerateVideoDevices() {
      console.log("[enumerateVideoDevices] Enumerating devices...");
      const devices = await navigator.mediaDevices.enumerateDevices();
      availableDevices = devices
        .filter(d => d.kind === 'videoinput')
        .map(d => {
          return {
            deviceId: d.deviceId,
            label: d.label || "Camera " + Math.floor(Math.random() * 10000),
            kind: d.kind
          };
        });
      console.log("[enumerateVideoDevices] Found video devices:", availableDevices);
    }

    /****************************************************
     * START CAMERA STREAM
     ****************************************************/
    async function startCameraStream() {
      console.log("[startCameraStream] Starting stream with device:", selectedDeviceId,
                  " | resolution:", selectedResolution.width + "x" + selectedResolution.height);

      // Stop any existing stream
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
      }

      const constraints = {
        video: {
          deviceId: selectedDeviceId ? { exact: selectedDeviceId } : undefined,
          width: { ideal: selectedResolution.width },
          height: { ideal: selectedResolution.height }
        },
        audio: false
      };

      try {
        currentStream = await navigator.mediaDevices.getUserMedia(constraints);
        player.srcObject = currentStream;
        player.play();
        console.log("[startCameraStream] Stream started successfully!");
      } catch (err) {
        console.error("[startCameraStream] Error:", err);
        alert("Failed to start camera. Try another device or resolution, or check console for errors.");
      }
    }

    /****************************************************
     * BUILD CAMERA OVERLAY
     ****************************************************/
    function buildCameraOverlay() {
      cameraPanel.innerHTML = ""; // clear old items
      availableDevices.forEach(device => {
        const btn = document.createElement("div");
        btn.className = "optionBtn";
        btn.textContent = device.label;
        btn.onclick = async () => {
          selectedDeviceId = device.deviceId;
          await startCameraStream();
          hidePanel(cameraPanel);
        };
        cameraPanel.appendChild(btn);
      });
    }

    /****************************************************
     * BUILD RESOLUTION OVERLAY
     ****************************************************/
    function buildResolutionOverlay() {
      resolutionPanel.innerHTML = "";
      availableResolutions.forEach(res => {
        const btn = document.createElement("div");
        btn.className = "optionBtn";
        btn.textContent = res.label;
        btn.onclick = async () => {
          selectedResolution = { width: res.width, height: res.height };
          await startCameraStream();
          hidePanel(resolutionPanel);
        };
        resolutionPanel.appendChild(btn);
      });
    }

    /****************************************************
     * SHOW/HIDE HELPER FUNCTIONS FOR PANELS
     ****************************************************/
    function togglePanel(panel) {
      panel.style.display = (panel.style.display === "none" || panel.style.display === "") 
        ? "block" : "none";
    }
    function hidePanel(panel) {
      panel.style.display = "none";
    }

    /****************************************************
     * FPS COUNTER
     ****************************************************/
    function setupFPSCounter() {
      let lastFrameTime = performance.now();
      let frameCount = 0;

      function updateFPS(currentTime) {
        frameCount++;
        const delta = currentTime - lastFrameTime;
        if (delta >= 1000) {
          const fps = Math.round((frameCount * 1000) / delta);
          document.getElementById("fpsCounter").textContent = `FPS: ${fps}`;
          frameCount = 0;
          lastFrameTime = currentTime;
        }
        requestAnimationFrame(updateFPS);
      }
      requestAnimationFrame(updateFPS);
    }
  </script>
</body>
</html>
